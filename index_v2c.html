<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8" />
    <title>Waze Nehody ‚Äî iPhone 16 Pro Max (Portrait)</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">

    <style>
        :root{
            --bg:#000;
            --muted:#bfbfbf;
            --neon-green:#39ff14;
            --neon-orange:#ff8a1f;
            --neon-yellow:#fff200;
            --waze-blue:#3232ff;
            --panel-border:rgba(255,255,255,0.06);
            --tap-size:48px;
            --safe-top:env(safe-area-inset-top);
            --safe-bottom:env(safe-area-inset-bottom);
            --safe-left:env(safe-area-inset-left);
            --safe-right:env(safe-area-inset-right);
        }

        html,body{
            height:100%;
            margin:0;
            background:var(--bg);
            font-family:Arial,Helvetica,sans-serif;
            -webkit-font-smoothing:antialiased;
            color:var(--muted);
        }

        .app{
            height:100vh;
            box-sizing:border-box;
            padding-top:calc(8px + var(--safe-top));
            padding-bottom:calc(8px + var(--safe-bottom));
            padding-left:calc(8px + var(--safe-left));
            padding-right:calc(8px + var(--safe-right));
            display:flex;
            flex-direction:column;
            overflow:hidden;
        }

        .header{
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:6px 8px;
        }

        .header .left{
            font-size:14px;
            color:var(--muted);
        }

        .header .center{
            flex:1;
            text-align:center;
        }

        .last-update{
            font-size:22px;
            font-weight:700;
            color:var(--neon-green);
        }

        .btn-refresh{
            background:#242424;
            color:var(--muted);
            border:1px solid var(--panel-border);
            border-radius:8px;
            padding:6px 10px;
            cursor:pointer;
            min-height:var(--tap-size);
        }

        .content{
            flex:1;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            padding:6px;
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        /* ACCIDENT CARD ONE ROW */
        .acc{
            border:1px solid var(--panel-border);
            padding:6px 10px;
            border-radius:10px;
            display:flex;
            flex-direction:column;
            gap:4px;
            color:var(--neon-orange);
        }

        .acc.top{
            font-size:20px;
        }

        .acc.top.recent{
            color:var(--neon-yellow);
        }

        .acc-line-main{
            display:flex;
            justify-content:space-between;
            align-items:center;
            width:100%;
            flex-wrap:nowrap;
        }

        .loc-major{
            font-weight:700;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;
        }

        .numbers-small{
            font-size:12px;
            color:#bbbbbb;
        }

        .acc-type{
            font-size:12px;
            font-weight:600;
            color:#aaa;
        }

        .nav-link{
            color:var(--waze-blue);
            font-weight:700;
            text-decoration:none;
            margin-left:10px;
            white-space:nowrap;
        }

        .message{
            color:var(--muted);
            text-align:center;
            padding:20px;
        }

        @media only screen and (min-width:430px) and (max-width:460px) and (orientation:portrait){
            .last-update{ font-size:24px; }
            .acc.top{ font-size:22px; }
        }

    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="left">Nehody üí•</div>
            <div class="center"><div id="last-update-time" class="last-update">--:--:--</div></div>
            <button class="btn-refresh" id="refreshBtn">Refresh</button>
        </header>

        <main class="content" id="accidents-container">
            <div class="message">Naƒç√≠tavam d√°ta...</div>
        </main>
    </div>

    <audio id="new-alert-audio" src="audio.wav" preload="auto"></audio>

<script>
    const KOMAR_LAT = 48.15706;
    const KOMAR_LON = 17.15049;

    const BASE_WAZE_URL = 'https://www.waze.com/live-map/api/georss?top=48.00677&bottom=48.29126&left=16.97313&right=17.43044&env=row&types=alerts';
    const CORS_PROXY = 'https://corsproxy.io/?';
    const WAZE_API_URL = CORS_PROXY + encodeURIComponent(BASE_WAZE_URL);

    let audioUnlocked = false;
    const audioEl = document.getElementById('new-alert-audio');

    function tryUnlockAudio(){
        if(audioUnlocked || !audioEl) return;
        const p = audioEl.play();
        if(p!==undefined){
            p.then(()=>{
                audioEl.pause();
                audioEl.currentTime=0;
                audioUnlocked = true;
            }).catch(()=>{
                audioEl.muted=true;
                audioEl.play().then(()=>{
                    audioEl.pause(); audioEl.currentTime=0; audioEl.muted=false;
                    audioUnlocked=true;
                }).catch(()=>{audioEl.muted=false;});
            });
        } else audioUnlocked=true;
    }

    ['click','touchstart','keydown'].forEach(e=>{
        document.addEventListener(e,tryUnlockAudio,{once:true,passive:true});
    });

    function nowStr(){
        const d=new Date();
        return d.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    }

    function updateLastUpdateTime(){
        document.getElementById('last-update-time').textContent=nowStr();
    }

    function calcDistance(lat1,lon1,lat2,lon2){
        const R=6371;
        const toRad=a=>a*Math.PI/180;
        const dLat=toRad(lat2-lat1);
        const dLon=toRad(lon2-lon1);
        const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function loadKnownIds(){
        try{
            const x=JSON.parse(localStorage.getItem('known_accidents')||'[]');
            return Array.isArray(x)?x:[];
        }catch(e){return [];}
    }

    function saveKnownIds(a){
        localStorage.setItem('known_accidents',JSON.stringify(a));
    }

    async function fetchWazeAccidents(){
        updateLastUpdateTime();
        const now=new Date();

        const container=document.getElementById('accidents-container');
        container.innerHTML='<div class="message">Naƒç√≠tavam...</div>';

        let knownIds = loadKnownIds();
        const initialized = localStorage.getItem('initialized_accidents')==='true';
        const newOnes=[];

        try{
            const resp=await fetch(WAZE_API_URL);
            if(!resp.ok) throw new Error("Chyba API "+resp.status);
            const data=await resp.json();
            if(!data.alerts) throw new Error("Neplatn√© d√°ta");

            const accidents=data.alerts.filter(a=>a.type==="ACCIDENT");
            if(accidents.length===0){
                container.innerHTML='<div class="message">≈Ωiadne nehody</div>';
                if(!initialized){
                    localStorage.setItem('initialized_accidents','true');
                    saveKnownIds([]);
                }
                return;
            }

            accidents.sort((a,b)=>b.pubMillis-a.pubMillis);

            if(!initialized){
                saveKnownIds(accidents.map(a=>a.pubMillis));
                localStorage.setItem('initialized_accidents','true');
                knownIds = accidents.map(a=>a.pubMillis);
            }

            const frag=document.createDocumentFragment();

            accidents.forEach((a,i)=>{
                const lat=a.location.y;
                const lon=a.location.x;
                const pub=new Date(a.pubMillis);
                const pubStr=pub.toLocaleTimeString('sk-SK',{hour:'2-digit',minute:'2-digit'});
                const ageMin=Math.abs((now-pub)/1000/60);
                const recent=ageMin<=30;

                const dist=calcDistance(KOMAR_LAT,KOMAR_LON,lat,lon).toFixed(1);
                const loc=a.street ? `${a.city||''} ${a.street}`.trim() : (a.city || `GPS ${lat.toFixed(4)},${lon.toFixed(4)}`);
                const id=a.pubMillis;

                if(initialized && !knownIds.includes(id)){
                    newOnes.push(id);
                    knownIds.push(id);
                }

                const wrap=document.createElement('div');
                wrap.className="acc"+(i<3?" top":"")+(recent && i<3?" recent":"");

                wrap.innerHTML=`
                    <div class="acc-line-main">
                        <span class="loc-major">${escapeHtml(loc)} ‚Ä¢ ${escapeHtml(pubStr)} ‚Ä¢ ${escapeHtml(dist)} km</span>
                        <a class="nav-link" href="https://waze.com/ul?ll=${lat},${lon}&navigate=yes" target="_blank" rel="noopener">Waze</a>
                    </div>

                    <div class="acc-type">${escapeHtml(a.subtype || a.type)}</div>
                    <div class="numbers-small">
                        ${escapeHtml(a.confidence||0)} |
                        ${escapeHtml(a.reliability||0)} |
                        üëç${escapeHtml(a.nThumbsUp||0)} |
                        ‚≠ê${escapeHtml(a.reportRating||0)}
                    </div>
                `;
                frag.appendChild(wrap);
            });

            container.innerHTML="";
            container.appendChild(frag);
            saveKnownIds(knownIds);

            if(newOnes.length>0 && audioEl){
                tryUnlockAudio();
                audioEl.currentTime=0;
                const playP=audioEl.play();
                if(playP) playP.catch(()=>{});
            }

        }catch(e){
            container.innerHTML=`<div class="message">Chyba: ${escapeHtml(e.message)}</div>`;
        }
    }

    function escapeHtml(s){
        return String(s)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#39;");
    }

    document.getElementById('refreshBtn').addEventListener('click',fetchWazeAccidents);

    fetchWazeAccidents();
    setInterval(fetchWazeAccidents,10000);
</script>
</body>
</html>
